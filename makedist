#! /bin/posh

# $Id$
# $URL$

set -ex

fgrep -q 435aaec721a95878c2bd5b73e403a97f9005f61f makedist

build=$(mktemp -d)
trap 'chmod -R u+rwX -- "$build";rm -rf -- "$build"' EXIT

svn up
svn export . $build/src
svn2cl -o $build/src/ChangeLog

cat >$build/src/Makefile.am <<EOF
lib_LTLIBRARIES = libavl.la
libavl_la_SOURCES = $(echo src/*)
libavl_la_LDFLAGS = -version-info 2:0:0
include_HEADERS = src/avl.h
dist_man_MANS = $(echo doc/*)
nobase_dist_doc_DATA = $(echo example/*)
EXTRA_DIST = makedist
EOF

(
	cd $build/src

	find /usr/share/libtool -name ltmain.sh -exec cp -v {} . \;
	cp -av /usr/share/common-licenses/GPL-3 COPYING
	cp -av /usr/share/common-licenses/LGPL-3 COPYING.LESSER

	aclocal
	autoconf
	automake --add-missing
	sh configure

	make -s distcheck

	echo print-archives: >>Makefile
	echo '	@echo $(DIST_ARCHIVES)' >>Makefile
	mkdir $build/archives
	mv $(make -s print-archives) $build/archives/
)

cp -a $build/archives/* .
